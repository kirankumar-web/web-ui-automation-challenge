pipeline {
    agent any

    tools {
        maven 'Maven-3.9'      
        jdk 'JDK-17'          
    }
    
    parameters {
    choice(name: 'ENV', choices: ['QA', 'UAT'], description: 'Select Environment')
    choice(name: 'BROWSER', choices: ['chrome', 'firefox'], description: 'Select Browser')
}

    environment {
        ALLURE_RESULTS = "target/allure-results"
        ALLURE_REPORT  = "target/allure-report"
        EXTENT_REPORT  = "test-output/ExtentReport.html"
    }

    stages {

        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Clean & Execute Tests') {
    steps {
        sh """
            mvn clean test \
            -Dsurefire.suiteXmlFiles=src/test/resources/testng.xml \
            -Denv=${params.ENV} \
            -Dbrowser=${params.BROWSER}
        """
    }
}

        stage('Generate Allure Report') {
            steps {
                sh '''
                    mvn allure:report
                '''
            }
        }

        stage('Publish Allure Report') {
            steps {
                allure(
                    includeProperties: false,
                    jdk: '',
                    results: [[path: "${ALLURE_RESULTS}"]]
                )
            }
        }

        stage('Publish Extent Report') {
            steps {
                publishHTML(target: [
                    allowMissing: true,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'test-output',
                    reportFiles: 'ExtentReport.html',
                    reportName: 'Extent Test Report'
                ])
            }
        }

        stage('Archive Test Artifacts') {
            steps {
                archiveArtifacts artifacts: '**/target/surefire-reports/*, **/test-output/**', fingerprint: true
            }
        }
    }

    post {

        success {
            echo "‚úÖ Build and Tests completed successfully"
        }

        failure {
            echo "‚ùå Build or Tests failed"
        }

        always {
            echo "üìå Pipeline execution completed"
        }
    }
}
